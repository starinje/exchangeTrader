{"version":3,"sources":["../../src/services/gemini.js"],"names":["createRequestConfig","key","secret","payload","encodedPayload","Buffer","JSON","stringify","toString","signature","createHmac","update","digest","GeminiService","options","requestPrivate","endpoint","params","Error","requestUrl","baseUrl","nonce","Date","now","request","config","requestOptions","method","uri","headers","session","logger","info","requestPublic","body","getOrderBook","orderBook","timestamp","bids","map","bidLevel","price","amount","asks","askLevel","executeTrade","tradeDetails","action","quantity","rate","orderParams","client_order_id","symbol","side","type","newOrder","orderResults","tradeCompleted","tradeCompletedDetails","delay","orderStatus","order_id","tradeStatus","executed_amount","original_amount","availableBalances","orderId","subdomain","sandbox","defaults","json"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;AAGA,SAASA,mBAAT,OAAsD;AAAA,QAAvBC,GAAuB,QAAvBA,GAAuB;AAAA,QAAlBC,MAAkB,QAAlBA,MAAkB;AAAA,QAAVC,OAAU,QAAVA,OAAU;;;AAEpD,QAAMC,iBAAkB,IAAIC,MAAJ,CAAWC,KAAKC,SAAL,CAAeJ,OAAf,CAAX,CAAD,CACpBK,QADoB,UAAvB;;AAGA,QAAMC,YAAY,iBACfC,UADe,WACMR,MADN,EAEfS,MAFe,CAERP,cAFQ,EAGfQ,MAHe,OAAlB;;AAKA,WAAO;AACH,2BAAmBX,GADhB;AAEH,4BAAoBG,cAFjB;AAGH,8BAAsBK;AAHnB,KAAP;AAKD;;IAGoBI,a,GAEjB,uBAAYC,OAAZ,EAAoB;AAAA;;AAAA;;AAAA,SAapBC,cAboB;AAAA,8DAaH,iBAAMC,QAAN;AAAA,gBAAgBC,MAAhB,uEAAyB,EAAzB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,kCAEL,CAAC,MAAKH,OAAL,CAAab,GAAd,IAAqB,CAAC,MAAKa,OAAL,CAAaZ,MAF9B;AAAA;AAAA;AAAA;;AAAA,kCAGC,IAAIgB,KAAJ,gEAHD;;AAAA;AAQHC,sCARG,QAQa,MAAKC,OARlB,GAQ4BJ,QAR5B;AAUHb,mCAVG;AAWLkB,uCAAOC,KAAKC,GAAL,EAXF;AAYLC,iDAAeR;AAZV,+BAaFC,MAbE;AAiBHQ,kCAjBG,GAiBMzB,oBAAoB;AAC/BG,gDAD+B;AAE/BF,qCAAK,MAAKa,OAAL,CAAab,GAFa;AAG/BC,wCAAQ,MAAKY,OAAL,CAAaZ;AAHU,6BAApB,CAjBN;AAuBHwB,0CAvBG,GAuBc;AACnBC,wCAAQ,MADW;AAEnBC,qCAAKT,UAFc;AAGnBU,yCAASJ;AAHU,6BAvBd;AAAA;AAAA,mCA6BI,MAAKK,OAAL,CAAaJ,cAAb,CA7BJ;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AA+BT,kCAAKK,MAAL,CAAYC,IAAZ;AA/BS;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAbG;;AAAA;AAAA;AAAA;AAAA;;AAAA,SAiDpBC,aAjDoB;AAAA,8DAiDJ,kBAAOjB,QAAP;AAAA,gBAAiBC,MAAjB,uEAA0B,EAA1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEFS,0CAFE,GAEe;AACnBC,wCAAQ,KADW;AAEnBC,0CAAQ,MAAKR,OAAb,GAAuBJ,QAFJ;AAGnBkB,mDACOjB,MADP;AAHmB,6BAFf;AAAA;AAAA,mCAUK,MAAKa,OAAL,CAAaJ,cAAb,CAVL;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAYR,kCAAKK,MAAL,CAAYC,IAAZ;AAZQ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAjDI;;AAAA;AAAA;AAAA;AAAA;;AAAA,SAkEpBG,YAlEoB,6CAkEL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAEe,MAAKF,aAAL,iBAAmC,EAAnC,CAFf;;AAAA;AAEHG,iCAFG;AAIHC,iCAJG,GAISD,UAAUE,IAAV,CAAe,CAAf,EAAkBD,SAJ3B;AAMDC,4BANC,GAMMF,UAAUE,IAAV,CAAeC,GAAf,CAAmB,UAACC,QAAD,EAAc;AAC1C,mCAAO;AACHC,uCAAOD,SAASC,KADb;AAEHC,wCAAQF,SAASE;AAFd,6BAAP;AAIH,yBALY,CANN;AAaDC,4BAbC,GAaMP,UAAUO,IAAV,CAAeJ,GAAf,CAAmB,UAACK,QAAD,EAAc;AAC1C,mCAAO;AACHH,uCAAOG,SAASH,KADb;AAEHC,wCAAQE,SAASF;AAFd,6BAAP;AAIH,yBALY,CAbN;AAAA,0DAoBA,EAAEC,UAAF,EAAQL,UAAR,EAAaD,oBAAb,EApBA;;AAAA;AAAA;AAAA;;AAsBP,8BAAKN,MAAL,CAAYC,IAAZ;;AAtBO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAlEK;;AAAA,SA6FpBa,YA7FoB;AAAA,8DA6FL,kBAAOC,YAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAEP,kCAAKf,MAAL,CAAYC,IAAZ,cAA4Bc,aAAaC,MAAzC,6BAAuED,aAAaE,QAApF,sBAA6GF,aAAaG,IAA1H;;AAEIC,uCAJG,GAIW;AACdC,iDAAiB,kBADH;AAEdC,wCAAQ,QAFM;AAGdV,wCAAQI,aAAaE,QAHP;AAIdP,uCAAOK,aAAaG,IAJN;AAKdI,sCAAMP,aAAaC,MALL;AAMdO,sCAAM;AANQ,6BAJX;AAAA;AAAA,mCAakB,MAAKC,QAAL,CAAcL,WAAd,CAblB;;AAAA;AAaHM,wCAbG;AAeHC,0CAfG,GAec,KAfd;AAgBHC,iDAhBG;;AAAA;AAAA,gCAkBAD,cAlBA;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAmBG,mBAAQE,KAAR,CAAc,IAAd,CAnBH;;AAAA;AAAA;AAAA,mCAoBqB,MAAKC,WAAL,CAAiBJ,aAAaK,QAA9B,CApBrB;;AAAA;AAoBCC,uCApBD;;AAqBH,gCAAGA,YAAYC,eAAZ,IAA+BD,YAAYE,eAA9C,EAA8D;AAC1DP,iDAAiB,IAAjB;AACAC,wDAAwBI,WAAxB;AACH;AAxBE;AAAA;;AAAA;AAAA,8DA0BAJ,qBA1BA;;AAAA;AAAA;AAAA;;AA6BP,kCAAK3B,MAAL,CAAYC,IAAZ;;AA7BO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SA7FK;;AAAA;AAAA;AAAA;AAAA;;AAAA,SA8HpBuB,QA9HoB;AAAA,8DA8HT;AAAA,gBAAOtC,MAAP,uEAAgB,EAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACM,MAAKF,cAAL;AACToC,iDAAiB,wBADR;AAETG;AAFS,+BAGNrC,MAHM,EADN;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SA9HS;;AAAA;AAAA;AAAA;AAAA;;AAAA,SAsIpBgD,iBAtIoB,6CAsIA;AAAA;AAAA;AAAA;AAAA;AAAA,0DACT,MAAKlD,cAAL,aADS;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAtIA;;AAAA,SA0IpB6C,WA1IoB,GA0IN,UAACM,OAAD,EAAa;AACvB,eAAO,MAAKnD,cAAL,kBAAqC,EAAE8C,UAAUK,OAAZ,EAArC,CAAP;AACH,KA5ImB;;AAChB,SAAKpD,OAAL,GAAeA,WAAW,EAA1B;AACA,SAAKiB,MAAL,GAAc,KAAKjB,OAAL,CAAaiB,MAA3B;AACA,QAAMoC,YAAY,KAAKrD,OAAL,CAAasD,OAAb,wBAAlB;AACA,SAAKhD,OAAL,gBAA0B+C,SAA1B;AACA,SAAKrC,OAAL,GAAe,yBAAGuC,QAAH,CAAY;AACvBC,cAAM,IADiB;AAEvBzC,iBAAS;AACL,0BAAc;AADT;AAFc,KAAZ,CAAf;AAMH,C;;kBAbgBhB,a","file":"gemini.js","sourcesContent":["import rp from 'request-promise'\nimport crypto from 'crypto';\nimport shortid from 'shortid';\nimport Promise from 'bluebird'\n\n\nfunction createRequestConfig({ key, secret, payload }){\n\n  const encodedPayload = (new Buffer(JSON.stringify(payload)))\n    .toString(`base64`);\n\n  const signature = crypto\n    .createHmac(`sha384`, secret)\n    .update(encodedPayload)\n    .digest(`hex`);\n\n  return {\n      'X-GEMINI-APIKEY': key,\n      'X-GEMINI-PAYLOAD': encodedPayload,\n      'X-GEMINI-SIGNATURE': signature,\n  };\n}\n\n\nexport default class GeminiService {\n\n    constructor(options){\n        this.options = options || {}\n        this.logger = this.options.logger\n        const subdomain = this.options.sandbox ? `api.sandbox` : `api`;\n        this.baseUrl = `https://${subdomain}.gemini.com/v1`;\n        this.session = rp.defaults({\n            json: true,\n            headers: {\n                'User-Agent': 'Request-Promise'\n            }\n        })\n    }\n\n    requestPrivate = async(endpoint, params = {}) => {\n        try{\n            if (!this.options.key || !this.options.secret) {\n                throw new Error(\n                    `API key and secret key required to use authenticated methods`,\n                );\n            }\n\n            const requestUrl = `${this.baseUrl}${endpoint}`\n\n            const payload = {\n                nonce: Date.now(),\n                request: `/v1${endpoint}`,\n                ...params,\n            };\n\n\n            const config = createRequestConfig({\n                payload,\n                key: this.options.key,\n                secret: this.options.secret,\n            });\n\n            const requestOptions = {\n                method: 'POST',\n                uri: requestUrl,\n                headers: config\n            }\n\n            return await this.session(requestOptions)\n        } catch(err) {\n            this.logger.info(`error: ${err}`)\n            return \n        }\n    }\n\n    requestPublic = async (endpoint, params = {}) => {\n        try {\n            const requestOptions = {\n                method: 'GET',\n                uri: `${this.baseUrl}${endpoint}`,\n                body: {\n                    ...params\n                }\n            }\n\n            return await this.session(requestOptions) \n        } catch(err) {\n            this.logger.info(`error: ${err}`)\n            return \n        } \n    }\n\n    getOrderBook = async () => {\n        try{\n            let orderBook = await this.requestPublic(`/book/ethusd`, {})\n\n            let timestamp = orderBook.bids[0].timestamp\n\n            const bids = orderBook.bids.map((bidLevel) => {\n                return {\n                    price: bidLevel.price,\n                    amount: bidLevel.amount\n                }\n            })\n\n            const asks = orderBook.asks.map((askLevel) => {\n                return {\n                    price: askLevel.price,\n                    amount: askLevel.amount\n                }\n            })\n\n            return { asks, bids,timestamp}\n        } catch(err){\n            this.logger.info(err)\n        }\n\n    }\n\n    executeTrade = async (tradeDetails) => {\n        try{\n            this.logger.info(`placing ${tradeDetails.action} trade on Gemini for ${tradeDetails.quantity} ethereum at $${tradeDetails.rate}/eth`)\n        \n            let orderParams = { \n                client_order_id: \"20150102-4738721\", \n                symbol: 'ethusd',       \n                amount: tradeDetails.quantity,        \n                price: tradeDetails.rate,\n                side: tradeDetails.action,\n                type: 'exchange limit'\n            }\n\n            let orderResults = await this.newOrder(orderParams)\n\n            let tradeCompleted = false\n            let tradeCompletedDetails\n\n            while(!tradeCompleted){\n                await Promise.delay(1000)\n                let tradeStatus = await this.orderStatus(orderResults.order_id)\n                if(tradeStatus.executed_amount == tradeStatus.original_amount){\n                    tradeCompleted = true\n                    tradeCompletedDetails = tradeStatus\n                }\n            }\n            return tradeCompletedDetails\n\n        } catch(err){\n            this.logger.info(err)\n        }\n    }\n\n    newOrder = async (params = {}) => {\n        return await this.requestPrivate(`/order/new`, {\n            client_order_id: shortid(),\n            type: `exchange limit`,\n            ...params,\n        })\n    }\n\n    availableBalances = async () => {\n        return this.requestPrivate(`/balances`)\n    }\n\n    orderStatus = (orderId) => {\n        return this.requestPrivate(`/order/status`, { order_id: orderId })\n    }\n}"]}