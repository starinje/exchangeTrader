{"version":3,"sources":["../../src/services/gemini.js"],"names":["createRequestConfig","key","secret","payload","encodedPayload","Buffer","JSON","stringify","toString","signature","createHmac","update","digest","GeminiService","options","requestPrivate","endpoint","params","Error","requestUrl","baseUrl","nonce","Date","now","request","config","requestOptions","method","uri","headers","session","reject","requestPublic","body","getOrderBook","orderBook","timestamp","bids","map","bidLevel","price","amount","asks","askLevel","executeTrade","tradeDetails","logger","info","action","quantity","orderParams","client_order_id","symbol","rate","side","type","newOrder","orderResults","tradeCompleted","delay","orderStatus","order_id","tradeStatus","executed_amount","original_amount","orderHistory","tradeSummary","availableBalances","orderId","err","trades","orderTrades","filter","trade","fee","numberOfTrades","forEach","parseFloat","fee_amount","averagePrice","subdomain","sandbox","defaults","json"],"mappings":"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","file":"gemini.js","sourcesContent":["import rp from 'request-promise'\nimport crypto from 'crypto';\nimport shortid from 'shortid';\nimport Promise from 'bluebird'\n\n\nfunction createRequestConfig({ key, secret, payload }){\n\n  const encodedPayload = (new Buffer(JSON.stringify(payload)))\n    .toString(`base64`);\n\n  const signature = crypto\n    .createHmac(`sha384`, secret)\n    .update(encodedPayload)\n    .digest(`hex`);\n\n  return {\n      'X-GEMINI-APIKEY': key,\n      'X-GEMINI-PAYLOAD': encodedPayload,\n      'X-GEMINI-SIGNATURE': signature,\n  };\n}\n\n\nexport default class GeminiService {\n\n    constructor(options){\n        this.options = options || {}\n        this.logger = this.options.logger\n        const subdomain = this.options.sandbox ? `api.sandbox` : `api`;\n        this.baseUrl = `https://${subdomain}.gemini.com/v1`;\n        this.session = rp.defaults({\n            json: true,\n            headers: {\n                'User-Agent': 'Request-Promise'\n            }\n        })\n    }\n\n    requestPrivate = async(endpoint, params = {}) => {\n        try{\n            if (!this.options.key || !this.options.secret) {\n                throw new Error(\n                    `API key and secret key required to use authenticated methods`,\n                );\n            }\n\n            const requestUrl = `${this.baseUrl}${endpoint}`\n\n            const payload = {\n                nonce: Date.now(),\n                request: `/v1${endpoint}`,\n                ...params,\n            };\n\n\n            const config = createRequestConfig({\n                payload,\n                key: this.options.key,\n                secret: this.options.secret,\n            });\n\n            const requestOptions = {\n                method: 'POST',\n                uri: requestUrl,\n                headers: config\n            }\n\n            return await this.session(requestOptions)\n        } catch(err) {\n            return Promise.reject(`gemini requestPrivate |> ${err}`)\n        }\n    }\n\n    requestPublic = async (endpoint, params = {}) => {\n        try {\n            const requestOptions = {\n                method: 'GET',\n                uri: `${this.baseUrl}${endpoint}`,\n                body: {\n                    ...params\n                }\n            }\n\n            return await this.session(requestOptions) \n        } catch(err) {\n            return Promise.reject(`gemini requestPublic |> ${err}`)\n        } \n    }\n\n    getOrderBook = async () => {\n        try{\n            let orderBook = await this.requestPublic(`/book/ethusd`, {})\n\n            let timestamp = orderBook.bids[0].timestamp\n\n            const bids = orderBook.bids.map((bidLevel) => {\n                return {\n                    price: bidLevel.price,\n                    amount: bidLevel.amount\n                }\n            })\n\n            const asks = orderBook.asks.map((askLevel) => {\n                return {\n                    price: askLevel.price,\n                    amount: askLevel.amount\n                }\n            })\n\n            return { asks, bids,timestamp}\n        } catch(err){\n            return Promise.reject(`gemini getOrderBook |> ${err}`)\n        }\n\n    }\n\n    executeTrade = async (tradeDetails, orderBook) => {\n        try{\n            orderBook = await this.getOrderBook()\n            this.logger.info('retrieving latest order book from gemini')\n            let price\n\n            switch(tradeDetails.action){\n                case 'buy':\n                    price = orderBook.bids[0].price\n                    break\n                case 'sell':\n                    price = orderBook.asks[0].price\n                    break\n            }\n\n            this.logger.info(`placing ${tradeDetails.action} trade on Gemini for ${tradeDetails.quantity} ethereum at $${price}/eth`)\n        \n            let orderParams = { \n                client_order_id: \"20150102-4738721\", \n                symbol: 'ethusd',       \n                amount: tradeDetails.quantity,        \n                price: tradeDetails.rate,\n                side: tradeDetails.action,\n                type: 'exchange limit',\n            }\n\n            let orderResults = await this.newOrder(orderParams)\n            \n            let tradeCompleted = false\n\n            while(!tradeCompleted){\n                await Promise.delay(1000)\n                let tradeStatus = await this.orderStatus(orderResults.order_id)\n                if(tradeStatus.executed_amount == tradeStatus.original_amount){\n                    tradeCompleted = true\n                }\n            }\n\n            let tradeSummary = await this.orderHistory(orderResults.order_id)\n\n            return {...tradeSummary, action: tradeDetails.action}\n\n        } catch(err){\n            return Promise.reject(`gemini executeTrade |> ${err}`)\n        }\n    }\n\n    newOrder = async (params = {}) => {\n        try {\n            return await this.requestPrivate(`/order/new`, {\n                client_order_id: shortid(),\n                type: `exchange limit`,\n                ...params,\n            })\n        } catch(err){\n            return Promise.reject(`gemini newOrder |> ${err}`)\n        }\n        \n    }\n\n    availableBalances = async () => {\n        try {\n            return this.requestPrivate(`/balances`)\n        } catch(err){\n            return Promise.reject(`gemini availableBalances |> ${err}`)\n        }\n    }\n\n    orderStatus = (orderId) => {\n        try {\n            return this.requestPrivate(`/order/status`, { order_id: orderId })\n        } catch(err){\n            return Promise.reject(`gemini orderStatus |> ${err}`)\n        }\n    }\n\n    orderHistory = async (orderId) => {\n        try {\n            let trades = await this.requestPrivate(`/mytrades`, { symbol: 'ETHUSD'} )\n            let orderTrades = trades.filter((trade) =>{\n                return trade.order_id == orderId\n            })\n\n            let fee = 0\n            let amount = 0\n            let price = 0\n            let numberOfTrades = 0\n\n            orderTrades.forEach((trade) => {\n                fee = parseFloat(trade.fee_amount) + fee\n                amount = parseFloat(trade.amount) + amount\n                price = parseFloat(trade.price) + price\n                numberOfTrades = numberOfTrades + 1\n            })\n\n            let averagePrice = price / numberOfTrades\n\n            let tradeSummary = {\n                fee,\n                amount,\n                price: averagePrice\n            }\n\n            return tradeSummary\n        } catch(err){\n            return Promise.reject(`gemini orderStatus |> ${err}`)\n        }\n    }\n}"]}